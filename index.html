<!DOCTYPE html>
<html>
  <head>
    <title>Native Messaging for Browser Extensions</title>
    <meta charset='utf-8'>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
    <script class='remove'>
      var respecConfig = {
	shortName: "native-messaging",
	edDraftURI:"https://browserext.github.io/native-messaging/",

	specStatus: "CG-DRAFT",
	editors: [
	  {
	    name: "Andrew Swan",
	    company:"Mozilla"
	  },
	  {
        name: "Mike Pietraszak",
        company: "Microsoft Corporation "
      }
],

	wg: "Browser Extension Community Group",
	wgURI: "https://www.w3.org/community/browserext/",

	otherLinks: [{
	  key: 'Participation',
	  data: [
	    {
	      value: 'GitHub repository',
	      href: 'https://github.com/browserext/native-messaging/'
	    },
	    {
	      value: 'File a bug / view open issues',
	      href: 'https://github.com/browserext/native-messaging/issues'
	    }
	  ]
	}],
      };
    </script>
  </head>
  <body>
    <section id='abstract'>
      <p>
      Various applications of <a href="///browserext.github.io/browserext/">Browser Extensions</a>
      need a mechanism to communicate with local processes outside of the browser environment.
      This specification proposes such a mechanism.
      </p>
    </section>
    <section id='sotd'>
      <p>
      If you wish to make comments regarding this document, please file issues on
      <a href="https://github.com/browserext/native-messaging/issues/">github</a>.
      A <a href="mailto:public-browserext@w3.org">public mailing list</a> 
      (<a href="mailto:public-browserext-request@w3.org?subject=subscribe">subscribe</a>,
      <a href="http://lists.w3.org/Archives/Public/public-browserext/">archives</a>)
      is also available,
      but is reserved for high level discussions,
      and is not appropriate for specific comments about this document.
      </p>

      <p>
      Work on this document is governed by
      <a href="http://browserext.github.io/charter/">the charter</a> of the Browser Extension CG,
      which includes among other things the <a href="http://browserext.github.io/charter/#communication">Communication</a>,
      <a href="http://browserext.github.io/charter/#decision-policy">Decision</a>,
      and <a href="http://browserext.github.io/charter/#contribution-mechanics">Contribution</a> policies
      of this community group.
      </p>

    </section>

    <section class='informative'>
      <h2>Introduction</h2>
      <p>The Browser Extensions Community Group's goal is to make browser extension code much more interoperable across browsers by specifying common extension interfaces and well-defined browser behavior. </p>
      <p>This specification defines the interfaces and behavior which enables extensions to communicate with local client native processes outside of the browser environment.</p>
    </section>

    <section class='informative'>
        <h2>Core APIs</h2>
        <p>The goal for these APIs is to provide functionality that extension authors need for:</p>
        <ul>
            <li>message-passing between extensions and local client processes outside of the browser</li>
            <li>message-passing to long-lasting connection-based ports</li>
            <li>message-passing to connectionless processes</li>
        </ul>
        <section>
            <h4 id="runtime">The <code>runtime</code> object</h4>
            <section class="introductory">
                <h4>Overview</h4>
                <p>
                    In addition to the base functionality of the <code>browser.runtime</code> object defined in the <a href="https://browserext.github.io/browserext#runtime">Browser Extensions specification</a>, these additional APIs provide functionaly for Native Messaging.
                </p>
            </section><section class="introductory">
                <h4>Manifest</h4>
                <p>
                    The <code>"nativeMessaging"</code> permission is required to use these additional APIs.
                </p>
<pre>
{
    "permissions": [                               // Required
        "nativeMessaging"                          // Required
    ]                                              // Required   
}
</pre>
            </section>
            <section class="introductory">
                <h4>Context</h4>
                <p>
                    This API is available in Window context (background, event, popup, options and custom pages), Content Script context, and Internet-hosted web page context.
                </p>
            </section>
            <section class="introductory">
                <h4>WebIDL Definition</h4>
                <p>
                    A description of the special <a href="#webidl">WebIDL syntax considerations</a> for browser extensions are defined elsewhere in the <a href="https://browserext.github.io/browserext">Browser Extensions specification</a>.
                </p>
                <p class="issue">What is the correct WebIDL way to define these additions to <code>browser.runtime</code>? These additional APIs are like a subclass of <code>browser.runtime</code>. Need to check the WebIDL spec and update here as needed.</p>
<pre class="def idl">
dictionary BrowserExtRuntimePort {
    Function disconnect;
    DOMString name;
    object onDisconnect;
    object onMessage;
    Function postMessage;
    MessageSender sender;
};

callback BrowserExtRuntimeSendNativeMessageCallback = void (any response);

[NoInterfaceObject]
interface BrowserExtBrowserRuntimeNativeMessaging {
    BrowserExtRuntimePort connectNative(DOMString nativeServiceName);
    void sendNativeMessage(DOMString nativeServiceName, object message, optional RuntimeSendNativeMessageCallback callback);
    BrowserExtRuntimePort Port;
};

[NoInterfaceObject, Exposed=Window, CheckAnyPermissions="nativeMessaging"]
interface BrowserExtRuntimeNativeMessagingAPI {
    readonly attribute BrowserExtRuntimeNativeMessaging runtime; 
};

Browser implements BrowserExtRuntimeNativeMessagingAPI;
</pre>
            </section>
        </section>
    </section>

    <section class='informative'>
        <h2>Client Native Service Registration</h2>
        <p>The client native service must register itself in such a way that the browser will be able to:</p>
        <ul>
            <li>Locate the native component on the client</li>
            <li>Start the process for the service when needed</li>
            <li>Filter the sending of messages to the service, only allowing specified extensions to send messages</li>
        </ul>
        <p>Each browser implementation may have different mechanisms for this registration and lifetime management of the client native service. The examples below may not be applicable for all browsers, irrespective of the operating system.</p>
        <section class='informative'>
            <h3>Example: Windows</h3>
            <p>For Example, a browser on the Windows operating system may choose to implement registration that utilizes the Windows registry:</p>
<pre class="example">
HKEY_CURRENT_USER\Software\&lt;BrowserName&gt;\NativeMessagingHosts\&lt;ClientNativeServiceJSONRegistrationFileNamePath&gt;
HKEY_LOCAL_MACHINE\Software\&lt;BrowserName&gt;\NativeMessagingHosts\&lt;ClientNativeServiceJSONRegistrationFileNamePath&gt;
</pre>
            <p>The value in this key is the fully-qualified path to a JSON registration file such as "c:\path\example.json".</p>
            <p>The JSON registration file may contain information such as:</p>
<pre class="example">
{
    "name" : "&lt;The ID used to connect to this client native service&gt;",
    "description" : "&lt;description&gt;",
    "path" : "&lt;fully-qualified path to the executable for the client native service (e.g. "c:\path\sample.exe")&gt;",
    "type" : "&lt;how messages are sent (e.g. "stdio")&gt;",
    "allowed_extensions" : [ "&lt;extension ID&gt;"] (e.g. "browserext:/MyExtension_c1wakc4j0nefm", "browserext://dfcijpibodeoenkablikbkiobbdnkfki")
}
</pre>
        </section>
        <section class='informative'>
            <h3>Example: Mac OS</h3>
            <p>For Example, a browser on the Mac operating system may choose to implement registration that...</p>
        </section>
    </section>

    <section class='informative'>
        <h2>Sending Messages from Site Pages to Client Native Services</h2>
        <p>As specified in the <a href="https://browserext.github.io/browserext">Browser Extensions</a> specification, web site pages may use the <a href="https://browserext.github.io/browserext#runtime"><code>runtime.sendMessage</code></a> API to send messages to a particular extension. 
        If the extension supports the <a href="https://browserext.github.io/browserext/externally_connectable"><code>externally_connectable</code></a> messages and the sending page is allowed in the specified <code>matches</code> list, it may pass these messages on to 
        client native services.</p>
        <p>Because browser vendors use their own specific <a href="https://browserext.github.io/browserext#extensoin-ids">ID naming algorithms</a>, the site page code would necessarily have to detect the browser type and use the corresponding ID to send the extension a message.</p>
    </section>
    <section class='informative'>
        <h2>Content Security Polity (CSP)</h2>
        <p class="issue">The default CSP is discussed here <a href="https://www.w3.org/TR/CSP/">https://www.w3.org/TR/CSP/</a>.</p>
    </section>
  </body>
</html>
